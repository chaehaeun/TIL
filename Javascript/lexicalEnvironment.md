# 렉시컬 환경(lexical environment)

렉시컬 환경은 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조로 실행 컨텍스트를 구성하는 컴포넌트이다. <br/>
렉시컬 환경 객체는 두 부분으로 구성된다.

### ▶ 변수

1. 환경 레코드(Environment Record)
   - 모든 지역 변수를 프로퍼티로 저장하고 있는 객체. `this` 값과 같은 기타 정보도 여기에 저장된다.
   - '변수를 가져오거나 변경' 하는 것은 '환경 레코드의 프로퍼티를 가져오거나 변경함'을 의미한다.
2. 외부 렉시컬 환경(Outer Lexical Environment) 에 대한 참조
   - 외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킨다. 즉, 해당 실행 컨텍스트를 생성한 소스 코드를 포함하는 상위 코드의 렉시컬 환경을 말한다.

![](https://velog.velcdn.com/images/chaehe_3210/post/ff7ae58a-554e-4222-90a0-885d9b88c649/image.png)

이 경우 렉시컬 환경이 하나만 존재한다. 전역 렉시컬 환경은 외부 참조를 갖지 않기 때문에 화살표가 `null`을 가리키는 걸 확인할 수 있다.

### ▶ 함수 선언문

함수 선언문(function declaration)으로 선언한 함수는 일반 변수와 달리 바로 초기화 된다.<br/>
(🔔함수 표현식은 끌어올려지지 않는다)

![](https://velog.velcdn.com/images/chaehe_3210/post/e34c084e-e88c-4ff9-a98d-9ce1e2672056/image.png)

### ▶ 내부와 외부 렉시컬 환경

함수를 호출해 실행하면 새로운 렉시컬 환경이 만들어진다. 이 렉시컬 환경엔 함수 호출 시 넘겨받은 매개변수와 함수의 지역 변수가 저장된다.

![](https://velog.velcdn.com/images/chaehe_3210/post/4a6b1df9-0051-4b38-8b0a-7dccb997ec58/image.png)

코드에서 변수에 접근할 땐, 먼저 내부 렉시컬 환경을 검색 범위로 잡는다. 검색해서 원하는 변수를 찾지 못하면 검색 범위를 외부 렉시컬 환경으로 확장한다.

> 전역 렉시컬 환경에 도달할 때까지 변수를 찾지 못하면 엄격 모드에선 에러가 발생한다.

### ▶ 함수를 반환하는 함수

예시

```js
function makeCounter() {
  let count = 0;

  return function () {
    return count++;
  };
}

let counter = makeCounter();
```

1. `makeCounter()`를 호출하면 호출할 때마다 새로운 렉시컬 환경 객체가 만들어지고, 여기에 함수를 실행하는데 필요한 변수들이 저장된다.

2. `makeCounter()`가 실행되는 도중엔 본문이 한 줄 짜리인 중첩 함수가 만들어진다.(평가 단계기 때문에 생성만 되고 실행은 되지 않음)

> 💡 모든 함수는 함수가 생성된 곳의 렉시컬 환경을 기억한다. 함수는 `[[environment]]`라는 숨김 프로퍼티를 갖는데, 이곳에 함수가 만들어진 곳의 렉시컬 환경을 저장한다는 것.

3. 따라서 `counter.[[environment]]` 에는 `{count : 0}`이 있는 렉시컬 환경에 대한 참조가 저장된다.(함수의 호출 장소와 상관 없이 함수를 선언해도 되는 이유가 이것 때문)

4. 실행 흐름이 중첩 함수로 넘어가면, 함수 내부에 지역 변수 `count`가 없기 때문에 count 값을 외부 렉시컬 환경에서 검색해 가져온다.

5. `count++`가 실행되며 `count`이 1 증가하는데, **변숫값 갱신은 변수가 저장된 렉시컬 환경에서 이루어진다.** 그렇기 때문에 `counter()` 함수를 여러 번 호출하면 count 변수가 1씩 증가는 것.

<br/>

다른 예제

```js
const x = 1;

function foo() {
  const x = 10;
  // 상위 스코프는 함수 정의 환경(위치)에 따라 결정된다.
  // 함수 호출 위치와 상위 스코프는 아무런 관계가 없다.
  bar();
}

// 함수 bar는 자신의 상위 스코프,
//즉 전역 렉시컬 환경을 [[environment]]에 저장하여 기억한다
function bar() {
  console.log(x);
}

foo(); // 1
bar(); // 1
```

**렉시컬 스코프는 함수를 어디서 호출하는지가 아니라 <span style = "font-size : 16px; color: rgb(255, 54, 104)">어디에 선언하였는지</span>에 따라 결정된다.**
